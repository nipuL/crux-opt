# Description: Qt Free Edition
# URL: http://www.trolltech.com
# Packager: Johannes Winkelmann, jw at tks6 dot net
# Maintainer: Simone Rota, sip at crux dot nu
# Depends on: fontconfig, glib, libmng, libpng, mesa3d, xorg-libxcursor, xorg-libxi, xorg-libxinerama, xorg-libxrandr
name=qt4
version=4.3.3
release=1
source=(ftp://ftp.trolltech.com/pub/qt/source/qt-x11-opensource-src-$version.tar.gz)

build () {
    cd qt-x11-opensource-src-$version
    
    # fix qmake installation
    sed -i -e 's/-cp -P -f/-cp -L -f/' qmake/Makefile.unix

    local SQL
    if [ "`pkginfo -i | grep mysql`" ];then
	SQL="-qt-sql-mysql -I/usr/include/mysql -L/usr/lib/mysql"
    fi

    if [ -d /usr/include/nvidia ]; then
	export CFLAGS="$CFLAGS -I/usr/include/nvidia"
	export CXXFLAGS="$CXXFLAGS -I/usr/include/nvidia"
    fi

    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:`pwd`/lib"
    sed -i "s|-O2|$CXXFLAGS|" mkspecs/linux-g++/qmake.conf
    sed -i "s|-I. |$CXXFLAGS -I. |" qmake/Makefile.unix
    sed -i "s|read acceptance|acceptance=yes|" configure

    ./configure -prefix /usr/share/qt4 \
		-bindir /usr/share/qt4/bin \
		-headerdir /usr/include/qt4 \
		-libdir /usr/lib \
		-plugindir /usr/lib/qt4 \
		-platform linux-g++ -release -shared -sm \
		-tablet -nis -verbose -qt-gif -system-zlib \
		-system-lib{png,jpeg} \
		-no-{cups,fast,exceptions,nas-sound} \
		-x{cursor,inerama,kb,randr,render} \
                -nomake demos -nomake examples \
		$SQL
    sed -i "s|^install: install_subtargets install_htmldocs|install: install_subtargets|g" Makefile

    make
    make INSTALL_ROOT=$PKG install

    for i in mergetr msg2qm qconfig qembed qvfb; do
	(cd tools/$i/;make SUBLIBS="-lpng -lmng";mv $i $PKG/usr/bin/)
    done

    rm -rf `find $PKG/usr/share/qt4/mkspecs/* | \
	grep -v linux-g++ | grep -v common | grep -v features`
    rm -rf $PKG/usr/share/qt4/phrasebooks
    rm -f $PKG/usr/share/qt4/mkspecs/linux-g++/linux-g++

    rm -f $PKG/usr/share/qt4/bin/*.debug

    ln -s ../../include/qt4  $PKG/usr/share/qt4/include
    ln -s ../../lib          $PKG/usr/share/qt4/lib
    ln -s ../../lib/qt       $PKG/usr/share/qt4/plugins
    ln -s linux-g++          $PKG/usr/share/qt4/mkspecs/default

    sed -i "s|-L$SRC/qt-x11-opensource-src-$version/lib ||g" $PKG/usr/lib/*.prl
    sed -i "s|-L$SRC/qt-x11-opensource-src-$version/lib ||g" $PKG/usr/lib/pkgconfig/*.pc
    sed -i "s|$SRC/qt-x11-opensource-src-$version/bin|/usr/share/qt4/bin|g" $PKG/usr/lib/pkgconfig/*.pc
    chmod -R u+w,g-sw  $PKG
    chown -R root:root $PKG

    mkdir -p $PKG/usr/bin
    cd $PKG/usr/bin
    for f in assistant designer linguist lrelease lupdate moc qmake qtconfig uic; do 
        ln -s ../share/qt4/bin/$f $f-qt4
    done

    for f in pixeltool qdbus qdbuscpp2xml qdbusxml2cpp qt3to4 rcc uic3; do 
        ln -s ../share/qt4/bin/$f $f
    done


    rm -r $PKG/usr/share/qt4/translations
}
